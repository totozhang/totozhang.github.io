<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Network protocal, TCP," />





  <link rel="alternate" href="/atom.xml" title="Mathematic Revisit" type="application/atom+xml" />






<meta name="description" content="TIME_WAIT state is the most complicated status among the state transmit of TCP protocal, at first glance its existence is not nessesary, some of the optimization technique eliminate the TIME_WAIT stat">
<meta name="keywords" content="Network protocal, TCP">
<meta property="og:type" content="article">
<meta property="og:title" content="TIME_WAIT state">
<meta property="og:url" content="http://taotao.guru/2016-01-31-tcp-timewait-status/index.html">
<meta property="og:site_name" content="Mathematic Revisit">
<meta property="og:description" content="TIME_WAIT state is the most complicated status among the state transmit of TCP protocal, at first glance its existence is not nessesary, some of the optimization technique eliminate the TIME_WAIT stat">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://taotao.guru/2016-01-31-tcp-timewait-status/TCPTimeWait1.png">
<meta property="og:image" content="http://taotao.guru/2016-01-31-tcp-timewait-status/TCPTimeWait2.png">
<meta property="og:image" content="http://taotao.guru/2016-01-31-tcp-timewait-status/TCPTimeWait3.png">
<meta property="og:image" content="http://taotao.guru/2016-01-31-tcp-timewait-status/TCPTimeWait4.png">
<meta property="og:image" content="http://taotao.guru/2016-01-31-tcp-timewait-status/TCPTimeWait5.png">
<meta property="og:image" content="http://taotao.guru/2016-01-31-tcp-timewait-status/TCPTimeWait6.png">
<meta property="og:image" content="http://taotao.guru/2016-01-31-tcp-timewait-status/TCPTimeWait7.png">
<meta property="og:updated_time" content="2018-03-26T07:17:58.687Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="TIME_WAIT state">
<meta name="twitter:description" content="TIME_WAIT state is the most complicated status among the state transmit of TCP protocal, at first glance its existence is not nessesary, some of the optimization technique eliminate the TIME_WAIT stat">
<meta name="twitter:image" content="http://taotao.guru/2016-01-31-tcp-timewait-status/TCPTimeWait1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://taotao.guru/2016-01-31-tcp-timewait-status/"/>





  <title>TIME_WAIT state | Mathematic Revisit</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mathematic Revisit</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Trivialities on mathematics and computer science.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://taotao.guru/2016-01-31-tcp-timewait-status/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="toto">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/logo.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mathematic Revisit">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">TIME_WAIT state</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-01-31T23:29:55+08:00">
                2016-01-31
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Network-protocal/" itemprop="url" rel="index">
                    <span itemprop="name">Network protocal</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>TIME_WAIT state is the most complicated status among the state transmit of TCP protocal, at first glance its existence is not nessesary, some of the optimization technique eliminate the TIME_WAIT state arbitrarily. But as a part of a protocal which has been applied for so many years, there must be some reason. At least , before eliminating it, we should know the details about it, just as Richard Stevens referred in his book, “Instead of trying to avoid the state, we should understand it”。So what is a TIME_WAIT state TCP endpoint waiting for? Why the endpoint transimit to this state? What's the problems it brought us? Any way that we can keep away from these problems? <a id="more"></a></p>
<h1 id="how-long-does-time_wait-state-last">How long does TIME_WAIT state last?</h1>
<p>According to TCP specification, once a endpoint is in the TIME_WAIT state, it recommend that the endpoint should stay in this state for 2MSL to make sure the remote endpoint receiving the last FIN segment as much as possible. Once a endpoint is in TIME_WAIT state, the endpoints defining that connection cannot be reused.</p>
<div class="figure">
<img src="/2016-01-31-tcp-timewait-status/TCPTimeWait1.png" alt="处于TIME_WAIT状态的TCP端口">
<p class="caption">处于TIME_WAIT状态的TCP端口</p>
</div>
<p>2MSL is [Maximum Segment Lifetime] × 2, most of the Linux systems define the MSL 30s. 2MSL is 1 minutes. As we known, The longest life time for a IP packets stay alive in the network is marked by TTL, and TTL is stand for the maximum hops, so there's no close relationship between the MSL and TTL. In most version of the Linux kernel, MSL is hard coded, and the setting is 1 minutes. But there's also some other operation system that provided the configuration interface for this value.（<a href="http://lxr.free-electrons.com/source/include/net/tcp.h" target="_blank" rel="noopener">tcp.h</a>） <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//include/net/tcp.h</span><br><span class="line">#define TCP_TIMEWAIT_LEN (60*HZ) /* how long to wait to destroy TIME-WAIT state, about 60 seconds */</span><br></pre></td></tr></table></figure></p>
<h1 id="transmit-to-time_wait-state">Transmit to TIME_WAIT state</h1>
<p>According to the state transfermation of TCP protocal, the endpoint who initiate the FIN will enter the TIME_WAIT state, which means that no matter it's a client or server, who sent FIN, who TIME_WAIT. But on the other hand, client and server play a totally different role during the communication process. In another word, whether the client or the server transmitting to TIME_WAIT first, will lead to different consequences for the communication. Here are some details. In case 1~3, it's the client who initiates the FIN. In case 4~5, it's the server who asks for disconnect first.</p>
<h2 id="client-initiates-the-fin-request-first">Client initiates the FIN request first</h2>
<div class="figure">
<img src="/2016-01-31-tcp-timewait-status/TCPTimeWait2.png" alt="客户端主动断连">
<p class="caption">客户端主动断连</p>
</div>
<h3 id="case-1-client-initiates-the-fin-segment">Case 1 Client initiates the FIN segment</h3>
<p>First, I start the server process, run the client to connect to the server and do the application request for twice. Actually, the client sends two FIN during this operations. After this, I run the netstat to observe the printouts.</p>
<p>Printout on server <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#Server start, TCP port</span><br><span class="line">toto@guru:~$ netstat -ant | grep 1982</span><br><span class="line">tcp        0      0 0.0.0.0:1982            0.0.0.0:*               LISTEN</span><br><span class="line"></span><br><span class="line">#Client runs twice, the server side&apos;s printout</span><br><span class="line">toto@guru:~$ server </span><br><span class="line">Receive message from client process on 10.16.56.2: request,hostname</span><br><span class="line">Receive message from client process on 10.16.56.2: request,hostname</span><br><span class="line"></span><br><span class="line">#After client disconnect server for twice, the server tcp status.</span><br><span class="line">toto@guru:~$ netstat -ant | grep 1982</span><br><span class="line">tcp        0      0 0.0.0.0:1982            0.0.0.0:*               LISTEN</span><br></pre></td></tr></table></figure></p>
<p>Printout on client <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#Run the client twice</span><br><span class="line">toto@ClientOS:~$ client 10.22.5.3 1982</span><br><span class="line">response,guru</span><br><span class="line">toto@ClientOS:~$ client 10.22.5.3 1982</span><br><span class="line">response,guru</span><br><span class="line"></span><br><span class="line">#Check the tcp status</span><br><span class="line">toto@ClientOS:~$ netstat -ant | grep 1982</span><br><span class="line">tcp        0      0 10.16.56.2:55725         10.22.5.3:1982          TIME_WAIT</span><br><span class="line">tcp        0      0 10.16.56.2:55726         10.22.5.3:1982          TIME_WAIT</span><br></pre></td></tr></table></figure></p>
<p>The client process initiates FIN request for twice. Notice that, at the second time when the client connects to the server, it goes well, no rejection from the server. Because on the client the tcp port 55725 is time wait, the client os kernel assigns a brand new ephemeral port 55726 for the second connection. Most of the time, when the client raises a tcp connection request, a brand new client side port is assigned to the process. The ephemeral ports range is configurable. In Linux we can check it as this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">toto@guru:~$ cat /proc/sys/net/ipv4/ip_local_port_range </span><br><span class="line">32768	61000</span><br></pre></td></tr></table></figure>
<p>This case indacates that if a client initiates a FIN to finish the tcp connection. It will not take any effect to the server side, also not take any effect to itself. But during the design activity of a communication software system, if plenty of tcp connections are required at a very short period, and disconnect at a very short time, the client sides ports will mostly be exhausted. This situation should be considered and avoided. The alternative ways like tcp long term connection, tcp connection pool, or RST to disconnect should be used.</p>
<h3 id="case-2-client-side-binding-to-a-local-port-init-the-fin">Case 2 Client side binding to a local port init the FIN</h3>
<p>We bind a client to a specific local port,</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//bind a port to the sockfd</span><br><span class="line">sscanf(argv[1], &quot;%d&quot;, &amp;srcport);</span><br><span class="line">struct sockaddr_in clientaddr;</span><br><span class="line">bzero(&amp;clientaddr, sizeof(clientaddr));</span><br><span class="line">clientaddr.sin_family = AF_INET;</span><br><span class="line">clientaddr.sin_port = htons((uint16_t)srcport);</span><br><span class="line">Bind(sockfd, (SA *) &amp;clientaddr, sizeof(clientaddr));</span><br></pre></td></tr></table></figure>
<p>Modify the code, recompile and run the client twice.</p>
<p>Server printout <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#Server </span><br><span class="line">toto@guru:~$ netstat -ant | grep 1982</span><br><span class="line">tcp        0      0 0.0.0.0:1982            0.0.0.0:*               LISTEN</span><br><span class="line"></span><br><span class="line">toto@guru:~$ server </span><br><span class="line">Receive message from client process on 10.16.56.2: request,hostname</span><br></pre></td></tr></table></figure></p>
<p>Client printout <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#Client</span><br><span class="line">toto@ClientOS:~$ client 55555 10.22.5.3 1982</span><br><span class="line">response,guru</span><br><span class="line">toto@ClientOS:~$ client 55555 10.22.5.3 1982</span><br><span class="line">bind error: Address already in use</span><br><span class="line"></span><br><span class="line">toto@ClientOS:~$ netstat -ant | grep 1982</span><br><span class="line">tcp        0      0 10.16.56.2:55555         10.22.5.3:1982          TIME_WAIT</span><br></pre></td></tr></table></figure></p>
<p>It indicates that once a tcp connection in TIME_WAIT state, it cannot be recreated.</p>
<h3 id="case-3-client-side-binding-to-a-local-port-init-a-fin-to-a-server-then-this-client-init-another-syn-request-to-a-brand-new-server-process">Case 3 Client side binding to a local port init a FIN to a server, then this client init another SYN request to a brand new server process</h3>
<p>Run two server processes seperately on the host 10.22.5.3 and host 10.16.56.2. On the host 10.16.56.2, run client twice, we expect to establish two tcp connections, one is {10.16.56.2，55555，10.22.5.3，1982}, the other is {10.16.56.2，55555，10.16.56.2，1982}, we assume the two connections will be established successfully. But actually not on Ubuntu linux.</p>
<div class="figure">
<img src="/2016-01-31-tcp-timewait-status/TCPTimeWait3.png" alt="理想情况下，同端口客户端连接两个处于不同主机服务端">
<p class="caption">理想情况下，同端口客户端连接两个处于不同主机服务端</p>
</div>
<p>Client <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">toto@ClientOS:~$ client 55555 10.22.5.3 1982</span><br><span class="line">response,guru</span><br><span class="line">toto@ClientOS:~$ client 55555 10.16.56.2 1982</span><br><span class="line">bind error: Address already in use</span><br><span class="line"></span><br><span class="line">toto@ClientOS:~$ netstat -ant | grep 1982</span><br><span class="line">tcp        0      0 10.16.56.2:55555         10.22.5.3:1982          TIME_WAIT</span><br></pre></td></tr></table></figure></p>
<p>Obviously, they are two different tcp connections. Ubuntu linux forbid the usage of port &quot;55555&quot; to start a connection. This is not reasonable. We can only wait for the time out, and init the second connection.</p>
<p>Client <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">toto@ClientOS:~$ client 55555 10.16.56.2 1982</span><br><span class="line">response,ClientOS</span><br><span class="line">toto@ClientOS:~$ client 55555 10.22.5.3 1982</span><br><span class="line">bind error: Address already in use</span><br><span class="line"></span><br><span class="line">toto@ClientOS:~$ netstat -ant | grep 1982</span><br><span class="line">tcp        0      0 10.16.56.2:55555         10.16.56.2:1982          TIME_WAIT</span><br></pre></td></tr></table></figure></p>
<h2 id="server-init-the-fin-request">Server init the FIN request</h2>
<div class="figure">
<img src="/2016-01-31-tcp-timewait-status/TCPTimeWait4.png" alt="服务端主动断连">
<p class="caption">服务端主动断连</p>
</div>
<h3 id="case-4-server-init-the-fin-then-restart">Case 4 Server init the FIN, then restart</h3>
<p>TIME_WAIT brings kinds of problem to the server, and it will have a much greater influence to the communication than TIME_WAIT on the client's side. As a communication system engineer, the TIME_WAIT state on the server should bring our attention with a higher priority.</p>
<p>Start the server process, connect to it with two different clients. The two connections established successfully. Kill the server.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#Server</span><br><span class="line">toto@guru:~$ netstat -ant | grep 1982</span><br><span class="line">tcp        0      0 0.0.0.0:1982            0.0.0.0:*               LISTEN     </span><br><span class="line">tcp        0      0 10.22.5.3:1982          10.16.56.2:55555        TIME_WAIT  </span><br><span class="line">tcp        0      0 10.22.5.3:1982          10.16.56.2:55556        TIME_WAIT</span><br><span class="line"></span><br><span class="line">#Client</span><br><span class="line">toto@ClientOS:~$ netstat -ant | grep 1982</span><br><span class="line">～no output</span><br></pre></td></tr></table></figure>
<p>Try to restart the server, failed.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#Server</span><br><span class="line">toto@guru:~$ server </span><br><span class="line">bind error: Address already in use</span><br></pre></td></tr></table></figure>
<p>If the server init the FIN, the tcp endpoint on the server side enters the TIME_WAIT state. If a server is serving a huge amount of clients, all of the connections' state will transmit to TIME_WAIT at that moment.</p>
<h3 id="case-5-server-init-the-fin-client-which-binding-to-a-specific-port-init-the-syn-for-twice">Case 5 Server init the FIN, client which binding to a specific port init the SYN for twice</h3>
<p>Bind the client tcp port to 55555, connect the server twice.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#Client</span><br><span class="line">toto@ClientOS:~$ client 55555 10.22.5.3 1982</span><br><span class="line">response,guru</span><br><span class="line">toto@ClientOS:~$ client 55555 10.22.5.3 1982</span><br><span class="line">response,guru</span><br><span class="line"></span><br><span class="line">toto@ClientOS:~$ netstat -ant | grep 1982</span><br><span class="line">～no output</span><br><span class="line"></span><br><span class="line">#Server</span><br><span class="line">toto@guru:~$ server </span><br><span class="line">Receive message from client process on 10.16.56.2: request,hostname</span><br><span class="line">Receive message from client process on 10.16.56.2: request,hostname</span><br><span class="line"></span><br><span class="line">toto@guru:~$ netstat -ant | grep 1982</span><br><span class="line">tcp        0      0 0.0.0.0:1982            0.0.0.0:*               LISTEN     </span><br><span class="line">tcp        0      0 10.22.5.3:1982          10.16.56.2:55555        TIME_WAIT</span><br></pre></td></tr></table></figure>
<p>观察两端的数据收发情况，注意第2次建立TCP连接时的SYN分段，Wireshark自动将其标记为黑色并写明TCP Port Number Reused。说明服务端的TIME_WAIT状态并没有影响到外部客户端向服务端发起连接请求，TIME_WAIT的端口在这种状态下可以重用。 <img src="/2016-01-31-tcp-timewait-status/TCPTimeWait5.png" alt="服务端主动断开连接，客户端指定端口的数据交互"></p>
<h1 id="time_wait状态存在原因">TIME_WAIT状态存在原因</h1>
<p>为什么要设定这个2MSL时间限制呢？我们可以假设没有TIME_WAIT的时间限制，来看一下会是怎样的情景呢。</p>
<h2 id="情景1">情景1</h2>
<p>假设短时间内允许连续两次建立相同四元组定义的TCP连接，后建立的连接作为先建立连接的替身连接（incarnation）。如果第1次通信过程中的IP数据包在网络中某个节点发生延迟，并且延迟持续到替身建立时才送达对端，由于两次连接建立之间的等待时间间隔不足1MSL，导致了第1次通信中的数据实际在第2次通信过程中才到达接收端，导致莫名其妙的错误产生。 <img src="/2016-01-31-tcp-timewait-status/TCPTimeWait6.png" alt="两次使用相同四元组的TCP通信"></p>
<p>这种错误是小概率事件，首先，三次握手建立连接时，ISN初始序列号随机生成机制的作用就是为了避免网络延迟数据包被接收端错误接收。其次，客户端实现绑定端口号，操作系统内核为其分配临时端口号(ephemeral port)，临时端口号在每次创建新的连接时都会发生变化，每次建立连接使用的四元组标识是不一样的，所以建立一个替身需要的客户端端口号不会很快被重用。但小概率不等于0概率，尤其在大吞吐量高速网络中。如果事情有变坏的可能，不管这种可能性有多小，它总是会发生。TIME_WAIT的存在，可以确保2MSL时间内，替身连接不会重建，而延迟与网络中的TCP分段在MSL时间内确保已经死亡。</p>
<h2 id="情景2">情景2</h2>
<p>假设一个TCP连接在挥手切断的过程中，第3次挥手的FIN段或者第4次的ACK段丢失在网络中，后续会发生什么事情呢？参见下图，数据段“11.ACK”丢失导致服务端认为客户端没有收到“10.FIN”，超时重传“10.FIN”段。重传时，由于客户端没有等待2MSL时长，而提前终止了连接。TCP层在这种情况下，收到数据段会发送RST重置对端。收到RST的一端会向应用层报错，而应用层数据已经正常收发完成，也许对于应用层进程来说这种报错不需要处理，但是如果这个进程性命攸关呢？当客户端处于TIME_WAIT状态，会再次确认延迟到达的FIN。 <img src="/2016-01-31-tcp-timewait-status/TCPTimeWait7.png" alt="重发最后的FIN段"></p>
<p>以上两种情况的存在，促使TCP的设计者在TCP的状态中设计了TIME_WAIT状态。</p>
<h1 id="time_wait状态引发问题对策">TIME_WAIT状态引发问题对策</h1>
<p>需要针对TIME_WAIT状态引发的问题进行优化之前，需要充分评估风险并进行严格的后期和线上测试。不要过早优化，过早优化是万恶之源。</p>
<h2 id="对策1缩短time_wait的等待时长">对策1，缩短TIME_WAIT的等待时长</h2>
<p>修改TIME_WAIT的时间长度与具体系统有关，在Ubuntu Linux没有此参数设置的位置，如果实在要改就重新编译内核代码。其他系统诸如Windows，有注册表项与这个参数配置对应。</p>
<h2 id="对策2使用so_reuseaddr参数">对策2，使用SO_REUSEADDR参数</h2>
<p>创建Socket之后，立即设置SO_REUSEADDR，此时，进程运行完全忽视TIME_WAIT状态的存在。 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">int Socket(int family, int type, int protocol)</span><br><span class="line">&#123;</span><br><span class="line">    int sockfd = 0;</span><br><span class="line">    int optval = 1;</span><br><span class="line"></span><br><span class="line">    // Get a socket</span><br><span class="line">    if ((sockfd = socket(family, type, protocol)) &lt; 0)&#123;</span><br><span class="line">        err_sys(&quot;socket error&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    // Eliminates TIME_WAIT status</span><br><span class="line">    if (setsockopt(sockfd, SOL_SOCKET, SO_REUSEADDR, (const void *) &amp;optval, sizeof(int)) &lt; 0)&#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return sockfd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="对策3客户端主动断连">对策3，客户端主动断连</h2>
<p>由于哪一端发起断连请求FIN，哪一端进入TIME_WAIT状态，而进入TIME_WAIT状态端口过多主要是消耗资源，服务器与客户端相比较来说，资源更加宝贵，所以一般情况服务器不发送断连请求。但是这种情况下，如果客户端比较贪婪怎么办？你不发断连请求，老子就赖着不走。这时使用”对策4“，不想有尊严的走，那你就滚。</p>
<h2 id="对策4rst分段强制切断连接">对策4，RST分段强制切断连接</h2>
<p>无论是客户端或者服务端都可以使用RST段强制断掉TCP连接，任何一方不进入TIME_WAIT状态，TCP发送接收队列的数据立即清空。这样就规避了TIME_WAIT的问题。但是客户端与服务端怎么确认两侧的数据交互已经完成了呢？可以使用应用层消息中确认，比如在应用层发送端增加一个”Message Sent Over”消息，接收端回答“Copy That”，然后发送端发送RST段强切TCP连接。</p>
<h2 id="对策5修改参数tcp_tw_reusetcp_tw_recycle">对策5，修改参数tcp_tw_reuse，tcp_tw_recycle</h2>
<p>看了一些文章说这两个参数会引入很多问题，并违背了<a href="http://tools.ietf.org/html/rfc1122" target="_blank" rel="noopener">RFC1122</a>，这个RFC我还没读，具体的内容也没深入研究，不敢发表太多的见解，暂且留下这两个参数相关的内核代码连接。留个坑待有时间补充这部分内容。<a href="http://lxr.free-electrons.com/ident?i=tcp_twsk_unique" target="_blank" rel="noopener">tcp_tw_reuse源码</a>，<a href="http://lxr.free-electrons.com/ident?i=tcp_timewait_state_process" target="_blank" rel="noopener">tcp_tw_recycle源码</a>。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Network-protocal-TCP/" rel="tag"># Network protocal, TCP</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016-01-23-tcp-connection-status-transit/" rel="next" title="TCP协议连接状态迁移">
                <i class="fa fa-chevron-left"></i> TCP协议连接状态迁移
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016-02-07-tcp-abnormal-connection/" rel="prev" title="Abortion of TCP connection">
                Abortion of TCP connection <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/logo.jpg"
                alt="toto" />
            
              <p class="site-author-name" itemprop="name">toto</p>
              <p class="site-description motion-element" itemprop="description">About Math, About CS.</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">13</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:toto.zhang@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="skype:tao.zhang@ericsson.com?call|chat" target="_blank" title="Skype">
                      
                        <i class="fa fa-fw fa-skype"></i>Skype</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#how-long-does-time_wait-state-last"><span class="nav-number">1.</span> <span class="nav-text">How long does TIME_WAIT state last?</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#transmit-to-time_wait-state"><span class="nav-number">2.</span> <span class="nav-text">Transmit to TIME_WAIT state</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#client-initiates-the-fin-request-first"><span class="nav-number">2.1.</span> <span class="nav-text">Client initiates the FIN request first</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#case-1-client-initiates-the-fin-segment"><span class="nav-number">2.1.1.</span> <span class="nav-text">Case 1 Client initiates the FIN segment</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case-2-client-side-binding-to-a-local-port-init-the-fin"><span class="nav-number">2.1.2.</span> <span class="nav-text">Case 2 Client side binding to a local port init the FIN</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case-3-client-side-binding-to-a-local-port-init-a-fin-to-a-server-then-this-client-init-another-syn-request-to-a-brand-new-server-process"><span class="nav-number">2.1.3.</span> <span class="nav-text">Case 3 Client side binding to a local port init a FIN to a server, then this client init another SYN request to a brand new server process</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#server-init-the-fin-request"><span class="nav-number">2.2.</span> <span class="nav-text">Server init the FIN request</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#case-4-server-init-the-fin-then-restart"><span class="nav-number">2.2.1.</span> <span class="nav-text">Case 4 Server init the FIN, then restart</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case-5-server-init-the-fin-client-which-binding-to-a-specific-port-init-the-syn-for-twice"><span class="nav-number">2.2.2.</span> <span class="nav-text">Case 5 Server init the FIN, client which binding to a specific port init the SYN for twice</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#time_wait状态存在原因"><span class="nav-number">3.</span> <span class="nav-text">TIME_WAIT状态存在原因</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#情景1"><span class="nav-number">3.1.</span> <span class="nav-text">情景1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#情景2"><span class="nav-number">3.2.</span> <span class="nav-text">情景2</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#time_wait状态引发问题对策"><span class="nav-number">4.</span> <span class="nav-text">TIME_WAIT状态引发问题对策</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#对策1缩短time_wait的等待时长"><span class="nav-number">4.1.</span> <span class="nav-text">对策1，缩短TIME_WAIT的等待时长</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对策2使用so_reuseaddr参数"><span class="nav-number">4.2.</span> <span class="nav-text">对策2，使用SO_REUSEADDR参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对策3客户端主动断连"><span class="nav-number">4.3.</span> <span class="nav-text">对策3，客户端主动断连</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对策4rst分段强制切断连接"><span class="nav-number">4.4.</span> <span class="nav-text">对策4，RST分段强制切断连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#对策5修改参数tcp_tw_reusetcp_tw_recycle"><span class="nav-number">4.5.</span> <span class="nav-text">对策5，修改参数tcp_tw_reuse，tcp_tw_recycle</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">toto.zhang@gmail.com</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="custom_mathjax_source">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
  


  

  

</body>
</html>
